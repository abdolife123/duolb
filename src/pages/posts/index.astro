---
import Footer from "../../components/Footer.astro";
import Navbar from "../../components/navbar.astro";
import Layout from "../../layouts/Layout.astro";
import { supabase } from "../../lib/supabase";

/* ---------------- NATIVE UTF-8 NORMALIZATION ---------------- */
function fixText(str = "") {
  try {
    return new TextDecoder("utf-8").decode(new TextEncoder().encode(str));
  } catch {
    return str;
  }
}

const { data: rawPosts, error } = await supabase
  .from("posts")
  .select("title, slug, featured_image, created_at")
  .order("created_at", { ascending: false });

if (error) console.error(error);

const posts =
  rawPosts?.map((p) => ({
    ...p,
    title: fixText(p.title),
  })) || [];

Astro.response.headers.set(
  "Cache-Control",
  "public, max-age=0, s-maxage=600, stale-while-revalidate=86400"
)
---

<Layout
  title="Archiv | duolb Beauty Blog"
  description="Alle Beiträge im Duolb Beauty Blog: Hautpflege, Akne, Laser, RF Microneedling und Beauty-Tech im Überblick."
>

  <main class="bg-[var(--color-soft-white)] min-h-screen py-24 px-6">
    <div class="max-w-4xl mx-auto">
      <header class="text-center mb-24">
        <span
          class="text-[var(--color-gentle-gold)] font-bold tracking-[0.4em] uppercase text-[10px] mb-4 block italic"
          >Kuration</span
        >
        <h1 class="text-5xl md:text-6xl font-serif text-[var(--color-deep-slate)] mb-6">
          Alle Beiträge
        </h1>
        <div class="h-px w-24 bg-[var(--color-light-taupe)] mx-auto"></div>
      </header>

      <div class="space-y-12">
        {
          posts.map((post) => (
            <a href={`/posts/${post.slug}`} class="group block">
              <article class="flex flex-col md:flex-row gap-8 items-center border-b border-[rgba(230,226,221,0.35)] pb-12 transition-all group-hover:border-[var(--color-dusty-mauve)]">
                <div class="hidden md:block w-32 shrink-0">
                  <p class="text-[11px] font-bold uppercase tracking-widest text-[var(--color-medium-gray)] transition-colors group-hover:text-[var(--color-gentle-gold)]">
                    {new Date(post.created_at).toLocaleDateString("de-DE", {
                      day: "2-digit",
                      month: "short",
                      year: "numeric",
                    })}
                  </p>
                </div>

                <div class="w-full md:w-48 h-32 overflow-hidden rounded-sm bg-gray-100">
                  {post.featured_image && (
                    <img
                      src={post.featured_image}
                      alt={post.title}
                      class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
                    />
                  )}
                </div>

                <div class="flex-grow">
                  <h2 class="text-2xl md:text-3xl font-serif text-[var(--color-deep-slate)] leading-snug transition-colors group-hover:text-[var(--color-dusty-mauve)]">
                    {post.title}
                  </h2>
                  <div class="mt-4 flex items-center gap-4">
                    <span class="text-[10px] uppercase tracking-[0.2em] font-bold text-[var(--color-terracotta)] transition-colors group-hover:text-[var(--color-gentle-gold)]">
                      Artikel lesen
                    </span>
                    <span class="text-gray-300 group-hover:translate-x-2 transition-transform duration-300">
                      →
                    </span>
                  </div>
                </div>
              </article>
            </a>
          ))
        }
      </div>

      {
        posts.length === 0 && (
          <div class="text-center py-20">
            <p class="font-serif italic text-[var(--color-medium-gray)] text-xl text-center">
              In Kürze folgen neue Beiträge...
            </p>
      </div>
    )
  }
    </div>
  </main>

  <Footer />
</Layout>

<style>
  h1,
  h2 {
    font-family: "Cormorant Garamond", serif;
  }
</style>



