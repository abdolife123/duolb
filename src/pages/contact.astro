---
import Navbar from "../components/navbar.astro";
import Footer from "../components/Footer.astro";
import Layout from "../layouts/Layout.astro";
import { supabase } from "../lib/supabase";

let success = false;
let errorMsg = "";

/* ---------------- UTF-8 REPAIR FUNCTION ---------------- */
function repairUTF8(str = "") {
  try {
    const encoder = new TextEncoder();
    const decoder = new TextDecoder("utf-8");
    return decoder.decode(encoder.encode(str));
  } catch (e) {
    return str;
  }
}

try {
  if (Astro.request.method === "POST") {
    const formData = await Astro.request.formData();

    // Fix encoding for German characters from form input
    const name = repairUTF8(formData.get("name")?.toString().trim());
    const email = formData.get("email")?.toString().trim();
    const message = repairUTF8(formData.get("message")?.toString().trim());

    if (!name || !email || !message) {
      errorMsg = "Bitte alle Felder ausfüllen.";
    } else {
      const { error } = await supabase
        .from("messages")
        .insert([{ name, email, message }]);

      if (error) {
        console.error("Supabase INSERT error:", error);
        errorMsg = "Nachricht konnte nicht gesendet werden.";
      } else {
        success = true;
      }
    }
  }
} catch (err) {
  console.error("SERVER ERROR:", err);
  errorMsg = "Serverfehler. Bitte später erneut versuchen.";
}
---

<Layout
  title="Kontakt | duolb Beauty Blog"
  description="Kontaktiere die Duolb Beauty Redaktion. Fragen, Feedback oder Kooperation: Schreib uns eine Nachricht."
>

  <main
    class="bg-gradient-to-b from-[#FBF6F2]/20 to-white min-h-screen py-20 px-6"
  >
    <div class="max-w-4xl mx-auto">
      <div class="text-center mb-16">
        <span
          class="text-[#C6A75E] font-bold tracking-[0.2em] uppercase text-xs mb-4 block"
          >Kontakt aufnehmen</span
        >
        <h1 class="text-5xl font-serif text-gray-900 mb-6 text-center">
          Kontakt
        </h1>
        <p class="text-gray-600 text-lg max-w-xl mx-auto">
          Hast du Fragen, Feedback oder möchtest du mit uns zusammenarbeiten?
          Schreib uns gern eine Nachricht.
        </p>
      </div>

      <div class="grid lg:grid-cols-5 gap-12 items-start">
        <div class="lg:col-span-2 space-y-8">
          <div
            class="bg-white p-8 rounded-[2rem] shadow-sm border border-[#C6A75E]/10"
          >
            <h3 class="font-serif text-xl text-gray-900 mb-4">Direktkontakt</h3>
            <p class="text-gray-600 text-sm leading-relaxed mb-6">
              Wir bemühen uns, innerhalb von 24 Stunden auf alle Anfragen zu
              antworten.
            </p>
            <a
              href="mailto:contact@duolb.com"
              class="text-[#C6A75E] font-semibold hover:underline decoration-2"
            >
              contact@duolb.com
            </a>
          </div>

          <div class="px-8">
            <h4
              class="text-xs uppercase tracking-widest text-gray-400 font-bold mb-4"
            >
              Soziale Medien
            </h4>
            <div class="flex gap-4 text-[#C6A75E]">
              <span class="hover:scale-110 transition-transform cursor-pointer"
                >Instagram</span
              >
              <span class="hover:scale-110 transition-transform cursor-pointer"
                >Pinterest</span
              >
            </div>
          </div>
        </div>

        <div
          class="lg:col-span-3 bg-white p-8 md:p-12 rounded-[2rem] shadow-xl shadow-[#C6A75E]/5 border border-gray-50"
        >
          {
            success && (
              <div class="bg-green-50 border border-green-100 text-green-700 p-4 rounded-xl mb-8 flex items-center gap-3 animate-fade-in">
                <span class="text-xl">💌</span>
                <p class="font-medium">
                  Danke! Deine Nachricht wurde gesendet.
                </p>
              </div>
            )
          }

          {
            errorMsg && (
              <div class="bg-red-50 border border-red-100 text-red-700 p-4 rounded-xl mb-8">
                <p class="font-medium">{errorMsg}</p>
              </div>
            )
          }

          {
            !success && (
              <form method="POST" class="space-y-6">
                <div>
                  <label class="block text-xs font-bold uppercase tracking-widest text-gray-500 mb-2 ml-1">
                    Name
                  </label>
                  <input
                    type="text"
                    name="name"
                    placeholder="Dein Name"
                    required
                    class="w-full px-6 py-4 rounded-2xl bg-gray-50 border-transparent focus:bg-white focus:ring-2 focus:ring-[#C6A75E]/20 focus:border-[#C6A75E] transition-all outline-none"
                  />
                </div>

                <div>
                  <label class="block text-xs font-bold uppercase tracking-widest text-gray-500 mb-2 ml-1">
                    E-Mail Adresse
                  </label>
                  <input
                    type="email"
                    name="email"
                    placeholder="name@beispiel.de"
                    required
                    class="w-full px-6 py-4 rounded-2xl bg-gray-50 border-transparent focus:bg-white focus:ring-2 focus:ring-[#C6A75E]/20 focus:border-[#C6A75E] transition-all outline-none"
                  />
                </div>

                <div>
                  <label class="block text-xs font-bold uppercase tracking-widest text-gray-500 mb-2 ml-1">
                    Deine Nachricht
                  </label>
                  <textarea
                    name="message"
                    rows="5"
                    placeholder="Wie können wir dir helfen?"
                    required
                    class="w-full px-6 py-4 rounded-2xl bg-gray-50 border-transparent focus:bg-white focus:ring-2 focus:ring-[#C6A75E]/20 focus:border-[#C6A75E] transition-all outline-none resize-none"
                  />
                </div>

                <button
                  type="submit"
                  class="w-full bg-[#C6A75E] text-white font-bold py-5 rounded-2xl shadow-lg shadow-[#C6A75E]/20 hover:bg-[#9CAF9A] hover:-translate-y-1 transition-all active:scale-95 tracking-widest uppercase text-xs"
                >
                  Nachricht senden
                </button>
              </form>
            )
          }
        </div>
      </div>
    </div>
  </main>

  <Footer />
</Layout>

<style>
  h1,
  h3 {
    font-family: "Cormorant Garamond", serif;
  }
</style>

