---
export const prerender = false

import DirectoryLayout from "../../../../layouts/DirectoryLayout.astro"
import SalonImage from "@components/directory/SalonImage.astro"
import { supabase } from "../../../../lib/supabase"

const cityParam = decodeURIComponent(Astro.params.city || "").trim().toLowerCase()
const categoryParam = decodeURIComponent(Astro.params.category || "").trim().toLowerCase()
const pageParam = Number.parseInt(Astro.url.searchParams.get("page") || "1", 10)
const page = Number.isFinite(pageParam) && pageParam > 0 ? pageParam : 1
const pageSize = 9
const from = (page - 1) * pageSize
const to = from + pageSize - 1

const [{ data: cityData }, { data: categoryData }] = await Promise.all([
  supabase
    .from("cities")
    .select("id, name, slug, seo_title, seo_description, index_state")
    .ilike("slug", cityParam)
    .maybeSingle(),
  supabase
    .from("business_categories")
    .select("id, name, slug, seo_title, seo_description")
    .ilike("slug", categoryParam)
    .maybeSingle(),
])

const { data: cityCategoryPage } = await supabase
  .from("city_category_pages")
  .select("id, city_id, category_id, seo_title, seo_description, h1_title, intro_content, faq_content, is_indexable, salon_count")
  .eq("city_id", cityData?.id ?? -1)
  .eq("category_id", categoryData?.id ?? -1)
  .maybeSingle()

if (!cityCategoryPage) {
  return Astro.redirect("/404")
}

const { data: salons, count: salonsCount } = await supabase
  .from("salons")
  .select("salon_name, slug, cover_image, rating_value, rating_count, full_address", { count: "exact" })
  .eq("city_id", cityCategoryPage.city_id)
  .eq("category_id", cityCategoryPage.category_id)
  .order("rating_value", { ascending: false })
  .range(from, to)

const { data: relatedCategoryRows } = await supabase
  .from("city_category_pages")
  .select("category_id, salon_count, business_categories!inner(name, slug)")
  .eq("city_id", cityCategoryPage.city_id)
  .gt("salon_count", 0)
  .neq("category_id", cityCategoryPage.category_id)
  .order("salon_count", { ascending: false })

const relatedCategories = (relatedCategoryRows || [])
  .map((row) => {
    const category = Array.isArray(row.business_categories)
      ? row.business_categories[0]
      : row.business_categories

    if (!category?.slug || !category?.name) return null

    return {
      slug: category.slug,
      name: category.name,
      salonCount: row.salon_count ?? 0,
    }
  })
  .filter(Boolean)
const moreCategories = relatedCategories.slice(0, 8)

const title =
  cityCategoryPage.seo_title ||
  categoryData?.seo_title ||
  `${categoryData?.name || categoryParam} in ${cityData?.name || cityParam} - Bewertungen und Adressen`

const description =
  cityCategoryPage.seo_description ||
  categoryData?.seo_description ||
  `Finde die besten ${categoryData?.name || categoryParam} in ${cityData?.name || cityParam}. Vergleiche Bewertungen, Adressen und Leistungen.`

const h1Title =
  cityCategoryPage.h1_title ||
  `Die besten ${categoryData?.name || categoryParam} in ${cityData?.name || cityParam}`

const introContent = cityCategoryPage.intro_content || description
const faqItems = Array.isArray(cityCategoryPage.faq_content) ? cityCategoryPage.faq_content : []

const robots =
  cityData?.index_state && cityCategoryPage.is_indexable && (cityCategoryPage.salon_count ?? 0) > 0
    ? "index, follow"
    : "noindex, follow"
const currentPage = page
const pagePath = `/directory/city/${cityData?.slug || cityParam}/${categoryData?.slug || categoryParam}`
const buildPageUrl = (pageNumber: number) =>
  pageNumber > 1
    ? `https://duolb.com${pagePath}?page=${pageNumber}`
    : `https://duolb.com${pagePath}`
const canonicalUrl = buildPageUrl(currentPage)

const totalSalons = salonsCount ?? 0
const totalPages = Math.max(1, Math.ceil(totalSalons / pageSize))
const hasPrev = page > 1
const hasNext = page < totalPages
const previousUrl = currentPage > 1 ? buildPageUrl(currentPage - 1) : null
const nextUrl = currentPage < totalPages ? buildPageUrl(currentPage + 1) : null

Astro.response.headers.set(
  "Cache-Control",
  "public, max-age=0, s-maxage=600, stale-while-revalidate=86400"
)
if (robots === "noindex, follow") {
  Astro.response.headers.set("X-Robots-Tag", "noindex, follow")
}

const itemListSchema = {
  "@context": "https://schema.org",
  "@type": "ItemList",
  itemListElement: (salons || []).map((salon, index) => ({
    "@type": "ListItem",
    position: from + index + 1,
    url: `https://duolb.com/salon/${salon.slug}`,
    name: salon.salon_name,
  })),
}

const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    {
      "@type": "ListItem",
      position: 1,
      name: "Home",
      item: "https://duolb.com",
    },
    {
      "@type": "ListItem",
      position: 2,
      name: cityData?.name || cityParam,
      item: `https://duolb.com/directory/city/${cityData?.slug || cityParam}`,
    },
    {
      "@type": "ListItem",
      position: 3,
      name: categoryData?.name || categoryParam,
      item: `https://duolb.com/directory/city/${cityData?.slug || cityParam}/${categoryData?.slug || categoryParam}`,
    },
  ],
}
---

<head>
  <script type="application/ld+json" set:html={JSON.stringify(itemListSchema)} />
  {currentPage > 1 && previousUrl && <link rel="prev" href={previousUrl} />}
  {currentPage < totalPages && nextUrl && <link rel="next" href={nextUrl} />}
  <script
    type="application/ld+json"
    set:html={JSON.stringify(breadcrumbSchema, (key, value) =>
      value === undefined ? undefined : value
    )}
  />
</head>

<DirectoryLayout
  title={title}
  description={description}
  canonical={canonicalUrl}
  robots={robots}
>
  <section class="mb-10">
    <h1 class="text-3xl font-serif text-[var(--color-deep-slate)] mb-4">
      {h1Title}
    </h1>

    <p class="text-[var(--color-charcoal)] max-w-3xl">
      {introContent}
    </p>
  </section>

  {salons?.length ? (
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
      {salons.map((salon) => (
        <a href={`/salon/${salon.slug}`} class="bg-white rounded-[var(--radius-lg)] border border-[var(--color-light-taupe)] overflow-hidden shadow-[var(--shadow-sm)] group transition-all hover:-translate-y-1 hover:shadow-[var(--shadow-md)]">
          <SalonImage
            coverImage={salon.cover_image}
            alt={`${salon.salon_name} in ${cityData?.name || cityParam}`}
            class="h-48 w-full object-cover group-hover:scale-105 transition-transform duration-500"
          />
          <div class="p-5">
            <div class="text-[var(--color-gentle-gold)] text-sm mb-1">
              * {salon.rating_value ?? "-"} ({salon.rating_count ?? 0})
            </div>
            <h3 class="font-semibold text-[var(--color-deep-slate)]">{salon.salon_name}</h3>
            <p class="text-[var(--color-medium-gray)] text-sm">{salon.full_address}</p>
          </div>
        </a>
      ))}
    </div>
  ) : (
    <p class="text-[var(--color-medium-gray)]">Keine Eintraege gefunden.</p>
  )}

  {totalPages > 1 && (
    <nav class="mt-10 flex items-center justify-center gap-3" aria-label="Pagination">
      {hasPrev ? (
        <a
          href={`/directory/city/${cityData?.slug || cityParam}/${categoryData?.slug || categoryParam}?page=${page - 1}`}
          class="px-4 py-2 rounded border border-[var(--color-light-taupe)] bg-white text-[var(--color-deep-slate)]"
        >
          Zurueck
        </a>
      ) : (
        <span class="px-4 py-2 rounded border border-[var(--color-light-taupe)] text-[var(--color-medium-gray)] bg-[var(--color-warm-cream)]">Zurueck</span>
      )}
      <span class="text-sm text-[var(--color-medium-gray)]">Seite {page} von {totalPages}</span>
      {hasNext ? (
        <a
          href={`/directory/city/${cityData?.slug || cityParam}/${categoryData?.slug || categoryParam}?page=${page + 1}`}
          class="px-4 py-2 rounded border border-[var(--color-light-taupe)] bg-white text-[var(--color-deep-slate)]"
        >
          Weiter
        </a>
      ) : (
        <span class="px-4 py-2 rounded border border-[var(--color-light-taupe)] text-[var(--color-medium-gray)] bg-[var(--color-warm-cream)]">Weiter</span>
      )}
    </nav>
  )}

  <section class="mt-16">
    <h2 class="text-2xl font-serif text-[var(--color-deep-slate)] mb-6">
      Weitere Kategorien in {cityData?.name || cityParam}
    </h2>
    <div class="flex flex-wrap gap-3">
      {moreCategories.map((cat) => (
        <a
          href={`/directory/city/${cityData?.slug || cityParam}/${cat.slug}`}
          class="px-4 py-2 bg-[var(--color-warm-cream)] border border-[var(--color-light-taupe)] rounded-full text-sm text-[var(--color-deep-slate)] transition-colors hover:bg-[var(--color-gentle-gold)] hover:text-white hover:border-[var(--color-gentle-gold)]"
        >
          {cat.name} ({cat.salonCount})
        </a>
      ))}
    </div>
  </section>

  {faqItems.length > 0 && (
    <section class="mt-16">
      <h2 class="text-2xl font-serif text-[var(--color-deep-slate)] mb-6">Haeufige Fragen</h2>
      <div class="space-y-4">
        {faqItems.map((item) => (
          <article class="bg-white border border-[var(--color-light-taupe)] rounded-[var(--radius-lg)] p-5">
            <h3 class="font-semibold text-[var(--color-deep-slate)] mb-2">{item.question}</h3>
            <p class="text-[var(--color-charcoal)]">{item.answer}</p>
          </article>
        ))}
      </div>
    </section>
  )}

  <section class="mt-16 prose max-w-none">
    <p>
      <a href={`/directory/city/${cityData?.slug || cityParam}`}>Alle Salons in {cityData?.name || cityParam}</a>
      {" "}.{" "}
      <a href="/directory/category">Alle Kategorien ansehen</a>
    </p>
  </section>
</DirectoryLayout>
