---
export const prerender = true

import DirectoryLayout from "../../../../layouts/DirectoryLayout.astro"
import SalonImage from "@components/directory/SalonImage.astro"
import { supabase } from "../../../../lib/supabase"

export async function getStaticPaths() {
  const [{ data: cityCategoryPages, error: pagesError }, { data: cities, error: citiesError }, { data: categories, error: categoriesError }] = await Promise.all([
    supabase
      .from("city_category_pages")
      .select("city_id, category_id"),
    supabase
      .from("cities")
      .select("id, slug"),
    supabase
      .from("business_categories")
      .select("id, slug"),
  ])

  if (pagesError || citiesError || categoriesError) {
    console.error("getStaticPaths city/category source error", pagesError || citiesError || categoriesError)
    return []
  }

  const citySlugById = new Map((cities || []).map((row) => [row.id, row.slug]))
  const categorySlugById = new Map((categories || []).map((row) => [row.id, row.slug]))

  return (cityCategoryPages || [])
    .map((row) => {
      const city = citySlugById.get(row.city_id)
      const category = categorySlugById.get(row.category_id)
      if (!city || !category) return null
      return {
        params: { city, category }
      }
    })
    .filter(Boolean)
}

const { city, category } = Astro.params

// Fetch city info
const [{ data: cityData }, { data: categoryData }] = await Promise.all([
  supabase
    .from("cities")
    .select("id, name, slug, seo_title, seo_description")
    .eq("slug", city)
    .single(),
  supabase
    .from("business_categories")
    .select("id, name, slug, seo_title, seo_description")
    .eq("slug", category)
    .single(),
])

if (!cityData || !categoryData) {
  return Astro.redirect("/404")
}

// Fetch city-category SEO/index config
const { data: cityCategoryPage } = await supabase
  .from("city_category_pages")
  .select("seo_title, seo_description, h1_title, index_state, salon_count")
  .eq("city_id", cityData.id)
  .eq("category_id", categoryData.id)
  .single()

if (!cityCategoryPage || cityCategoryPage.salon_count === 0) {
  return Astro.redirect("/404")
}

// Fetch salons in this city + category
const { data: salons } = await supabase
  .from("salons")
  .select("salon_name, slug, cover_image, rating_value, rating_count, full_address")
  .eq("city_id", cityData.id)
  .eq("category_id", categoryData.id)
  .order("rating_value", { ascending: false })
  .limit(60)

// SEO content
const title =
  cityCategoryPage.seo_title ||
  categoryData.seo_title ||
  `${categoryData.name} in ${cityData.name} – Bewertungen & Adressen`

const description =
  cityCategoryPage.seo_description ||
  categoryData.seo_description ||
  `Finde die besten ${categoryData.name} in ${cityData.name}. Vergleiche Bewertungen, Adressen und Leistungen der Top Salons in deiner Nähe.`

const h1Title = cityCategoryPage.h1_title || `Die besten ${categoryData.name} in ${cityData.name}`
const robots = cityCategoryPage.index_state ? "index, follow" : "noindex, follow"
const canonicalUrl = `https://duolb.com/directory/city/${cityData.slug}/${categoryData.slug}`

Astro.response.headers.set(
  "Cache-Control",
  "public, max-age=0, s-maxage=600, stale-while-revalidate=86400"
)

const itemListSchema = {
  "@context": "https://schema.org",
  "@type": "ItemList",
  itemListElement: (salons || []).map((salon, index) => ({
    "@type": "ListItem",
    position: index + 1,
    url: `https://duolb.com/salon/${salon.slug}`,
    name: salon.salon_name,
  })),
}
---

<head>
  <script type="application/ld+json" set:html={JSON.stringify(itemListSchema)} />
</head>

<DirectoryLayout
  title={title}
  description={description}
  canonical={canonicalUrl}
  robots={robots}
>

  <section class="mb-10">
    <h1 class="text-3xl font-serif text-[var(--color-deep-slate)] mb-4">
      {h1Title}
    </h1>

    <p class="text-[var(--color-charcoal)] max-w-3xl">
      {description}
    </p>
  </section>

  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
    {salons?.length ? (
      salons.map(salon => (
        <a href={`/salon/${salon.slug}`} class="bg-white rounded-[var(--radius-lg)] border border-[var(--color-light-taupe)] overflow-hidden shadow-[var(--shadow-sm)] group transition-all hover:-translate-y-1 hover:shadow-[var(--shadow-md)]">
          <SalonImage
            coverImage={salon.cover_image}
            alt={`${salon.salon_name} in ${cityData.name}`}
            class="h-48 w-full object-cover group-hover:scale-105 transition-transform duration-500"
          />
          <div class="p-5">
            <div class="text-[var(--color-gentle-gold)] text-sm mb-1">
              ⭐ {salon.rating_value ?? "–"} ({salon.rating_count ?? 0})
            </div>
            <h3 class="font-semibold text-[var(--color-deep-slate)]">{salon.salon_name}</h3>
            <p class="text-[var(--color-medium-gray)] text-sm">{salon.full_address}</p>
          </div>
        </a>
      ))
    ) : (
      <p>Keine Einträge gefunden.</p>
    )}
  </div>

  {/* SEO Content Block */}
  <section class="mt-16 prose max-w-none">
    <h2>Worauf sollte man bei {categoryData.name} in {cityData.name} achten?</h2>
    <p>
      Die Wahl eines guten {categoryData.name} in {cityData.name} hängt von mehreren Faktoren ab.
      Bewertungen, Spezialisierungen und die Lage spielen eine wichtige Rolle.
      Viele Anbieter in {cityData.name} bieten unterschiedliche Leistungen an –
      von klassischen Behandlungen bis zu modernen Spezialtechniken.
    </p>

    <h2>Preise für {categoryData.name} in {cityData.name}</h2>
    <p>
      Die Preise variieren je nach Lage, Erfahrung und Leistungsumfang.
      Ein Vergleich der Salons in {cityData.name} hilft, das beste Preis-Leistungs-Verhältnis zu finden.
    </p>

    <h2>Häufige Leistungen</h2>
    <ul>
      <li>Individuelle Beratung</li>
      <li>Professionelle Behandlungen</li>
      <li>Moderne Techniken und Produkte</li>
      <li>Flexible Terminemöglichkeiten</li>
    </ul>

    <p>
      <a href={`/directory/city/${cityData.slug}`}>Alle Salons in {cityData.name}</a>
      {" "}·{" "}
      <a href="/directory/category">Alle Kategorien ansehen</a>
    </p>
  </section>

</DirectoryLayout>




