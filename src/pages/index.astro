---
import FeaturedPost from "../components/FeaturedPost.astro";
import PostCard from "../components/PostCard.astro";
import Newsletter from "../components/Newsletter.astro";
import Footer from "../components/Footer.astro";
import Layout from "../layouts/Layout.astro";
import { supabase } from "../lib/supabase";

/* ---------------- UTF-8 REPAIR ---------------- */
function repairUTF8(str = "") {
  try {
    return new TextDecoder("utf-8").decode(new TextEncoder().encode(str));
  } catch {
    return str;
  }
}

/* ---------------- FETCH POSTS ---------------- */
const { data: posts } = await supabase
  .from("posts")
  .select("title, slug, featured_image, created_at, description")
  .order("created_at", { ascending: false });

const fixedPosts =
  posts?.map((p) => ({
    ...p,
    title: repairUTF8(p.title),
    description: repairUTF8(p.description),
  })) ?? [];

const featuredPost = fixedPosts[0];
const otherPosts = fixedPosts.slice(1);
---

<Layout
title="Duolb | High-End Skincare, Akne-Behandlung & Laser-Technologie"
  description="Duolb ist Deutschlands Experten-Editorial f체r medizinische Hautpflege, Akne-Behandlung, Laser-Technologien und wissenschaftlich gepr체fte High-End Skincare."
  image="https://res.cloudinary.com/dc0ax30om/image/upload/v1769795790/duolb_og_xrs8qe.png"
>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    
    {/* HERO / FEATURED */}
    {featuredPost && (
      <section aria-label="Empfohlener Beitrag">
        <FeaturedPost post={featuredPost} />
      </section>
    )}

    {/* RECENT POSTS */}
    {otherPosts.length > 0 && (
      <section class="mt-16" aria-label="Neueste Beitr채ge">
        <h2 class="text-2xl font-serif text-gray-900 mb-8 border-l-4 border-[#958e09] pl-4">
          Weitere Beitr채ge
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {otherPosts.map((post) => (
            <PostCard post={post} />
          ))}
        </div>
      </section>
    )}
    
  </main>

  <Newsletter />
  <Footer />
</Layout>

<style>
  /* Base styles handled via Tailwind. Font should be imported in Layout.astro. */
</style>
