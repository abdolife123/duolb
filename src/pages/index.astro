---
import Layout from "../layouts/Layout.astro";
import Footer from "../components/Footer.astro";
import PostCard from "../components/PostCard.astro";
import { supabase } from "../lib/supabase";

import HomeHero from "../components/home/HomeHero.astro";
import HomeCategoryGrid from "../components/home/HomeCategoryGrid.astro";
import HomeCityGrid from "../components/home/HomeCityGrid.astro";
import HomeFeaturedSalons from "../components/home/HomeFeaturedSalons.astro";
import HomeSeoBlock from "../components/home/HomeSeoBlock.astro";
import HomeNearMe from "../components/home/HomeNearMe.astro";
import PublisherAd from "../components/ads/PublisherAd.astro";

/* ---------------- UTF-8 REPAIR (posts) ---------------- */
function repairUTF8(str = "") {
  try {
    return new TextDecoder("utf-8").decode(new TextEncoder().encode(str));
  } catch {
    return str;
  }
}

const [
  { data: categories },
  { data: cities },
  { data: featuredSalons },
  { data: posts },
] = await Promise.all([
  supabase
    .from("business_categories")
    .select("name, slug")
    .order("name")
    .limit(12),
  supabase
    .from("cities")
    .select("name, slug, salon_count")
    .gt("salon_count", 0)
    .order("salon_count", { ascending: false })
    .limit(12),
  supabase
    .from("salons")
    .select("salon_name, slug, cover_image, rating_value, rating_count, full_address, category_slug, city_slug")
    .order("rating_value", { ascending: false })
    .limit(12),
  supabase
    .from("posts")
    .select("title, slug, featured_image, created_at, description")
    .order("created_at", { ascending: false })
    .limit(3),
]);

const fixedPosts =
  posts?.map((p) => ({
    ...p,
    title: repairUTF8(p.title),
    description: repairUTF8(p.description),
  })) ?? [];

const title = "Duolb Verzeichnis: Beauty & Wellness Salons in Deutschland finden";
const description =
  "Finde Friseure, Kosmetikstudios, Nagelstudios und Wellnessanbieter in ganz Deutschland. Vergleiche Bewertungen, Standorte und Kontaktdaten mit Duolb.";

Astro.response.headers.set(
  "Cache-Control",
  "public, max-age=0, s-maxage=600, stale-while-revalidate=86400"
);

const categoryNameBySlug = new Map((categories || []).map((c) => [c.slug, c.name]));
const cityNameBySlug = new Map((cities || []).map((c) => [c.slug, c.name]));

const featuredSalonsWithContext =
  (featuredSalons || []).map((salon) => ({
    ...salon,
    category_name: salon.category_slug ? categoryNameBySlug.get(salon.category_slug) ?? null : null,
    city_name: salon.city_slug ? cityNameBySlug.get(salon.city_slug) ?? null : null,
  })) ?? [];

const organizationSchema = {
  "@context": "https://schema.org",
  "@type": "Organization",
  name: "Duolb",
  url: "https://duolb.com",
  logo: {
    "@type": "ImageObject",
    url: "https://res.cloudinary.com/dc0ax30om/image/upload/v1769795884/Capture_d_%C3%A9cran_2026-01-30_185740_yhkku3.png",
  },
};

const featuredItemListSchema = {
  "@context": "https://schema.org",
  "@type": "ItemList",
  itemListElement: featuredSalonsWithContext.map((salon, index) => ({
    "@type": "ListItem",
    position: index + 1,
    url: `https://duolb.com/salon/${salon.slug}`,
    name: `${salon.salon_name || "Salon"} – ${salon.category_name ?? "Beauty & Wellness"} in ${
      salon.city_name ?? "Deutschland"
    }`,
  })),
};
---

<Layout title={title} description={description} type="website">
  <main class="relative w-full pt-0">
    <!-- Ambient background (purely visual) -->
    <div aria-hidden="true" class="pointer-events-none absolute inset-0 -z-10 overflow-hidden">
      <div class="absolute -top-40 -left-40 h-[520px] w-[520px] rounded-full bg-[var(--color-soft-rose)] blur-3xl opacity-[0.25]"></div>
      <div class="absolute -bottom-40 -right-40 h-[560px] w-[560px] rounded-full bg-[var(--color-pale-blue)] blur-3xl opacity-[0.22]"></div>
    </div>

    <head>
      <script
        type="application/ld+json"
        set:html={JSON.stringify([organizationSchema, featuredItemListSchema])}
      />
    </head>

    <HomeHero categories={categories || []} cities={cities || []} />

    <PublisherAd
      tid="54193_897282_0"
      width={728}
      height={90}
      label="Anzeige"
      desktopOnly={true}
    />

    <HomeFeaturedSalons salons={featuredSalonsWithContext} />

    <nav
      class="mt-10 rounded-3xl border border-[var(--color-light-taupe)] bg-white p-6 shadow-[var(--shadow-sm)]"
      aria-label="Schnellnavigation"
    >
      <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
        <div>
          <p class="text-[11px] font-semibold uppercase tracking-[0.25em] text-[var(--color-medium-gray)]">
            Schnellstart
          </p>
          <h2 class="mt-2 text-2xl font-serif text-[var(--color-deep-slate)]">
            Finde Salons ohne Umwege
          </h2>
        </div>
        <p class="text-sm text-[var(--color-medium-gray)] max-w-xl md:text-right">
          Alle wichtigen Seiten sind in maximal 2–3 Klicks erreichbar: Startseite → Stadt/Kategorie → Salon.
        </p>
      </div>

      <div class="mt-6 grid gap-3 md:grid-cols-3">
        <a
          class="group rounded-2xl border border-[var(--color-light-taupe)] bg-[var(--color-warm-cream)] px-5 py-4 shadow-[var(--shadow-sm)] transition-all hover:-translate-y-0.5 hover:shadow-[var(--shadow-md)] hover:border-[var(--color-gentle-gold)]"
          href="/directory"
        >
          <div class="flex items-center justify-between gap-3">
            <span class="text-base font-semibold text-[var(--color-deep-slate)]">Beauty & Wellness Verzeichnis (Deutschland)</span>
            <span class="text-[var(--color-terracotta)] transition-transform group-hover:translate-x-1">→</span>
          </div>
          <p class="mt-2 text-xs text-[var(--color-medium-gray)]">
            Alle Anbieter nach Stadt, Kategorie und Bewertung.
          </p>
        </a>
        <a
          class="group rounded-2xl border border-[var(--color-light-taupe)] bg-[var(--color-warm-cream)] px-5 py-4 shadow-[var(--shadow-sm)] transition-all hover:-translate-y-0.5 hover:shadow-[var(--shadow-md)] hover:border-[var(--color-gentle-gold)]"
          href="/directory/city"
        >
          <div class="flex items-center justify-between gap-3">
            <span class="text-base font-semibold text-[var(--color-deep-slate)]">Salons nach Stadt in Deutschland</span>
            <span class="text-[var(--color-terracotta)] transition-transform group-hover:translate-x-1">→</span>
          </div>
          <p class="mt-2 text-xs text-[var(--color-medium-gray)]">
            Berlin bis München, schnell zur Übersicht.
          </p>
        </a>
        <a
          class="group rounded-2xl border border-[var(--color-light-taupe)] bg-[var(--color-warm-cream)] px-5 py-4 shadow-[var(--shadow-sm)] transition-all hover:-translate-y-0.5 hover:shadow-[var(--shadow-md)] hover:border-[var(--color-gentle-gold)]"
          href="/directory/category"
        >
          <div class="flex items-center justify-between gap-3">
            <span class="text-base font-semibold text-[var(--color-deep-slate)]">Salons nach Kategorie (Friseur, Kosmetik, Wellness)</span>
            <span class="text-[var(--color-terracotta)] transition-transform group-hover:translate-x-1">→</span>
          </div>
          <p class="mt-2 text-xs text-[var(--color-medium-gray)]">
            Friseur, Kosmetik, Nails, Wellness und mehr.
          </p>
        </a>
      </div>
    </nav>

    <section class="mt-12 rounded-3xl border border-[rgba(230,226,221,0.2)] bg-white p-6 shadow-[var(--shadow-sm)]" aria-label="Über das Verzeichnis">
      <h2 class="text-2xl font-serif text-[var(--color-deep-slate)]">Dein Beauty- & Wellness-Verzeichnis für Deutschland</h2>
      <p class="mt-3 text-sm text-[var(--color-charcoal)] leading-relaxed max-w-4xl">
        Duolb hilft dir, Beauty- und Wellness-Salons in ganz Deutschland zu finden und zu vergleichen. Nutze die
        Verzeichnis-Seiten nach <a class="text-[var(--color-terracotta)] hover:text-[var(--color-gentle-gold)] transition-colors" href="/directory/city">Stadt</a> oder
        <a class="text-[var(--color-terracotta)] hover:text-[var(--color-gentle-gold)] transition-colors" href="/directory/category">Kategorie</a>,
        um schnell passende Anbieter zu entdecken.
      </p>
    </section>

    <HomeCategoryGrid categories={categories || []} />

    <PublisherAd
      tid="54193_897282_1"
      width={300}
      height={250}
      label="Anzeige"
      class="flex justify-center"
    />

    <HomeCityGrid cities={cities || []} />

    <HomeNearMe categories={categories || []} />

    <PublisherAd
      tid="54193_897282_3"
      width={320}
      height={50}
      label="Anzeige"
      mobileOnly={true}
      class="flex justify-center"
    />

    <HomeSeoBlock
      topCities={(cities || []).slice(0, 6)}
      topCategories={(categories || []).slice(0, 6)}
    />

    <section class="mt-10 rounded-2xl border border-[var(--color-light-taupe)] bg-white p-5" aria-label="Ad test block">
      <p class="text-[11px] font-semibold uppercase tracking-[0.2em] text-[var(--color-medium-gray)] mb-4">
        Direct Ad Test
      </p>

      <div class="hidden md:flex justify-center mb-6">
        <script data-cfasync='false' type='text/javascript' src='//clksite.com/adServe/banners?tid=54193_897282_0'></script>
      </div>

      <div class="flex justify-center mb-6">
        <script data-cfasync='false' type='text/javascript' src='//clksite.com/adServe/banners?tid=54193_897282_1'></script>
      </div>

      <div class="flex justify-center mb-6">
        <script data-cfasync='false' type='text/javascript' src='//clksite.com/adServe/banners?tid=54193_897282_2'></script>
      </div>

      <div class="flex justify-center md:hidden">
        <script data-cfasync='false' type='text/javascript' src='//clksite.com/adServe/banners?tid=54193_897282_3'></script>
      </div>
    </section>

    <PublisherAd
      tid="54193_897282_2"
      width={300}
      height={250}
      label="Anzeige"
      class="flex justify-center"
    />

    <section class="mt-16" aria-labelledby="home-blog">
      <div class="flex flex-col gap-3 md:flex-row md:items-end md:justify-between">
        <div>
          <h2 id="home-blog" class="text-2xl md:text-3xl font-serif text-[var(--color-deep-slate)]">
            Beauty Ratgeber für Hautpflege, Behandlungen & moderne Kosmetik
          </h2>
          <p class="mt-2 text-sm text-[var(--color-charcoal)] max-w-2xl">
            Kurze, sachliche Artikel zu Akne-Behandlung, Laser-Technologien und moderner Hautpflege.
          </p>
        </div>
        <a
          href="/posts"
          class="text-sm font-semibold text-[var(--color-terracotta)] transition-colors hover:text-[var(--color-gentle-gold)]"
        >
          Alle Beiträge ansehen
        </a>
      </div>

      <div class="mt-8 grid grid-cols-1 gap-6 md:grid-cols-3">
        {fixedPosts.map((post) => (
          <PostCard post={post} />
        ))}
      </div>
    </section>
  </main>

  <Footer />
</Layout>
