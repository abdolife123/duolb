---
export const prerender = false;

import DirectoryLayout from "../../layouts/DirectoryLayout.astro"
import SalonImage from "../../components/directory/SalonImage.astro"
import SalonReviews from "../../components/reviews/SalonReviews.astro"
import { supabase } from "../../lib/supabase"
import { resolveSalonCoverImage } from "../../lib/images"

const { slug } = Astro.params

const { data: salon } = await supabase
  .from("salons")
  .select("*")
  .eq("slug", slug)
  .maybeSingle()

if (!salon) {
  return Astro.redirect("/directory")
}

const coverImage =
  resolveSalonCoverImage(salon.cover_image)

const phoneLink =
  typeof salon.phone === "string"
    ? salon.phone.replace(/[^\d+]/g, "")
    : ""

const bookingUrlRaw =
  typeof salon.booking_url === "string" ? salon.booking_url.trim() : ""
const bookingUrl =
  bookingUrlRaw && /^https?:\/\//i.test(bookingUrlRaw)
    ? bookingUrlRaw
    : bookingUrlRaw
      ? `https://${bookingUrlRaw}`
      : ""
const showBookNowCta = Boolean(salon.has_offers && bookingUrl)
const minimumDiscountLabel =
  salon.has_offers ? "Ab 10 % Rabatt" : ""

let city = null
if (salon.city_id) {
  const { data } = await supabase
    .from("cities")
    .select("name, slug")
    .eq("id", salon.city_id)
    .maybeSingle()
  city = data
}

let category = null
if (salon.category_id) {
  const { data } = await supabase
    .from("business_categories")
    .select("name, slug")
    .eq("id", salon.category_id)
    .maybeSingle()
  category = data
}

const relatedConditions = []
if (salon.city_id) relatedConditions.push(`city_id.eq.${salon.city_id}`)
if (salon.category_id) relatedConditions.push(`category_id.eq.${salon.category_id}`)

let relatedSalons = []
if (relatedConditions.length > 0) {
  const { data: relatedRaw, error: relatedError } = await supabase
    .from("salons")
    .select(
      "salon_name, slug, cover_image, rating_value, rating_count, full_address, city_id, category_id"
    )
    .neq("slug", salon.slug)
    .or(relatedConditions.join(","))
    .limit(24)

  if (relatedError) {
    console.error("related salons error", relatedError)
  }

  relatedSalons = (relatedRaw || [])
    .map((item) => {
      const isSameCity = Boolean(salon.city_id && item.city_id === salon.city_id)
      const isSameCategory = Boolean(
        salon.category_id && item.category_id === salon.category_id
      )
      const score = (isSameCity ? 2 : 0) + (isSameCategory ? 2 : 0)

      return { ...item, score }
    })
    .sort((a, b) => {
      if (b.score !== a.score) return b.score - a.score
      return (b.rating_value ?? 0) - (a.rating_value ?? 0)
    })
    .slice(0, 6)
}

// SEO
const title = `${salon.salon_name}${city ? ` in ${city.name}` : ""} – ${category?.name || "Salon"}`
const salonDescription =
  typeof salon.description === "string" ? salon.description.trim() : ""
const salonDescriptionText = salonDescription
  .replace(/<[^>]*>/g, " ")
  .replace(/\s+/g, " ")
  .trim()
const description =
  salonDescriptionText.slice(0, 155) ||
  `${salon.salon_name} in ${city?.name}. Adresse, Bewertungen und Leistungen im Überblick.`

Astro.response.headers.set(
  "Cache-Control",
  "public, max-age=0, s-maxage=600, stale-while-revalidate=86400"
)

const salonSchema = {
  "@context": "https://schema.org",
  "@type": "BeautySalon",
  name: salon.salon_name,
  url: `https://duolb.com/salon/${salon.slug}`,
  image: coverImage,
  description,
  telephone: salon.phone || undefined,
  address:
    salon.full_address || salon.postal_code || city?.name
      ? {
          "@type": "PostalAddress",
          streetAddress: salon.full_address || undefined,
          postalCode: salon.postal_code || undefined,
          addressLocality: city?.name || undefined,
          addressCountry: "DE",
        }
      : undefined,
  geo:
    salon.latitude && salon.longitude
      ? {
          "@type": "GeoCoordinates",
          latitude: salon.latitude,
          longitude: salon.longitude,
        }
      : undefined,
  aggregateRating:
    salon.rating_value
      ? {
          "@type": "AggregateRating",
          ratingValue: salon.rating_value,
          ratingCount: salon.rating_count ?? 0,
        }
      : undefined,
}
---

<head>
  <script
    type="application/ld+json"
    set:html={JSON.stringify(salonSchema, (key, value) =>
      value === undefined ? undefined : value
    )}
  />
</head>

<DirectoryLayout
  title={title}
  description={description}
  canonical={`https://duolb.com/salon/${salon.slug}`}
  image={coverImage}
>

<section class="max-w-6xl mx-auto px-6 py-14 text-[var(--color-charcoal)]">

  {/* HERO IMAGE */}
  <div class="salon-hero relative rounded-3xl overflow-hidden shadow-[var(--shadow-md)] ring-1 ring-[rgba(230,226,221,0.55)] mb-10">
    <SalonImage
      coverImage={salon.cover_image}
      alt={`${salon.salon_name}${city ? ` in ${city.name}` : ""}`}
      class="w-full h-[420px] md:h-[520px] object-cover"
      loading="eager"
      decoding="async"
      fetchpriority="high"
    />
    <div class="salon-hero-content">
      <div>
        <h1 class="text-4xl md:text-5xl font-bold tracking-tight text-[var(--color-soft-white)] mb-3 leading-tight">
          {salon.salon_name}{city ? ` in ${city.name}` : ""}
        </h1>

        <p class="text-base md:text-lg text-[var(--color-light-taupe)] max-w-3xl mb-4">
          Entdecke Leistungen, Standort und Kontaktdaten auf einen Blick.
        </p>

        <div class="flex flex-wrap items-center gap-3 text-sm">
          {category && (
            <a href={`/directory/city/${city?.slug}/${category.slug}`} class="salon-hero-pill px-3 py-1 rounded-full transition">
              {category.name}
            </a>
          )}
          {salon.rating_value && (
            <span class="salon-hero-pill salon-rating-pill px-3 py-1 rounded-full font-semibold">
              ⭐ {salon.rating_value} ({salon.rating_count ?? 0})
            </span>
          )}
          {salon.has_offers && (
            <span class="salon-hero-pill px-3 py-1 rounded-full">
              Angebote verfügbar
            </span>
          )}
        </div>
      </div>

      <div class="flex flex-wrap gap-3 md:justify-end">
        {!salon.has_offers && phoneLink && (
          <a href={`tel:${phoneLink}`} class="salon-cta px-6 py-3 rounded-xl font-semibold shadow-[var(--shadow-sm)] transition">
            Anrufen
          </a>
        )}
        {showBookNowCta && (
          <a href={bookingUrl} target="_blank" rel="noopener" class="salon-cta salon-cta-gold px-6 py-3 rounded-xl font-semibold shadow-[var(--shadow-sm)] transition">
            Jetzt buchen
          </a>
        )}
        {salon.website && (
          <a href={salon.website} target="_blank" rel="noopener" class="salon-cta-secondary border border-[rgba(230,226,221,0.55)] text-[var(--color-soft-white)] bg-transparent px-6 py-3 rounded-xl font-semibold transition">
            Website
          </a>
        )}
      </div>
    </div>
  </div>

  {salon.has_offers && bookingUrl && (
    <div class="offer-banners mb-10">
      <a href={bookingUrl} target="_blank" rel="noopener" class="offer-banner-card">
        <p class="offer-banner-eyebrow">Sonderaktion</p>
        <h2>{minimumDiscountLabel} bei {salon.salon_name}</h2>
      </a>
      <a href={bookingUrl} target="_blank" rel="noopener" class="offer-banner-card">
        <p class="offer-banner-eyebrow">Vorteil</p>
        <h2>Exklusive Angebote von {salon.salon_name}</h2>
      </a>
      <a href={bookingUrl} target="_blank" rel="noopener" class="offer-banner-card">
        <p class="offer-banner-eyebrow">Schnell sichern</p>
        <h2>Buche jetzt deinen Termin bei {salon.salon_name}</h2>
      </a>
    </div>
  )}

  {/* ADDRESS */}
  <div class="bg-white rounded-[var(--radius-lg)] shadow-[var(--shadow-sm)] p-6 mb-10 border border-[var(--color-light-taupe)]">
    <h2 class="text-[11px] font-semibold uppercase tracking-[0.25em] text-[var(--color-medium-gray)] mb-3">Adresse</h2>
    <p class="text-[var(--color-charcoal)] leading-relaxed">
      {salon.full_address}, {salon.postal_code} {city?.name}
    </p>
  </div>

  {/* DESCRIPTION */}
  {salonDescription && (
    <div class="prose prose-slate max-w-none mb-12">
      <h2 class="!text-slate-900">Über {salon.salon_name}</h2>
      <div class="!leading-relaxed" set:html={salonDescription}></div>
    </div>
  )}

  {/* REVIEWS */}
  <SalonReviews salonId={salon.id} salonSlug={salon.slug} />

  {/* SERVICES SEO BLOCK */}
  {category && city && (
    <div class="prose prose-slate max-w-none mb-12">
      <h2 class="!text-slate-900">{category.name} in {city.name}</h2>
      <p>
        {salon.salon_name} gehört zu den etablierten Anbietern für {category.name} in {city.name}.
        Besucher schätzen vor allem die Qualität der Leistungen, das freundliche Team
        und die angenehme Atmosphäre vor Ort.
      </p>
    </div>
  )}

  {/* MAP */}
  {salon.latitude && salon.longitude && (
    <div class="mb-12">
      <h2 class="text-2xl font-semibold text-[var(--color-deep-slate)] mb-4">Standort auf der Karte</h2>
      <iframe
        width="100%"
        height="350"
        loading="lazy"
        class="rounded-[var(--radius-lg)] border border-[var(--color-light-taupe)] bg-white"
        src={`https://www.google.com/maps?q=${salon.latitude},${salon.longitude}&output=embed`}
      ></iframe>
    </div>
  )}

  {/* RELATED SALONS */}
  {relatedSalons.length > 0 && (
    <section class="mt-16 mb-10">
      <div class="flex flex-wrap items-end justify-between gap-4 mb-6">
        <h2 class="text-2xl font-semibold text-[var(--color-deep-slate)]">
          Ähnliche Salons
        </h2>
        {city && (
          <a
            href={`/directory/city/${city.slug}`}
            class="text-sm font-semibold text-[var(--color-terracotta)] transition-colors hover:text-[var(--color-gentle-gold)]"
          >
            Mehr in {city.name}
          </a>
        )}
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {relatedSalons.map((item) => (
          <a
            href={`/salon/${item.slug}`}
            class="bg-white rounded-[var(--radius-lg)] overflow-hidden shadow-[var(--shadow-sm)] border border-[var(--color-light-taupe)] transition-all hover:-translate-y-1 hover:shadow-[var(--shadow-md)]"
          >
            <SalonImage
              coverImage={item.cover_image}
              alt={`${item.salon_name}${city ? ` in ${city.name}` : ""}`}
              class="h-44 w-full object-cover"
            />
            <div class="p-4">
              <h3 class="font-semibold text-[var(--color-deep-slate)] mb-2">{item.salon_name}</h3>
              <p class="text-sm text-[var(--color-medium-gray)] line-clamp-2 mb-2">
                {item.full_address || "Adresse nicht verfügbar"}
              </p>
              <div class="text-sm text-[var(--color-gentle-gold)] font-semibold">
                ⭐ {item.rating_value ?? "–"} ({item.rating_count ?? 0})
              </div>
            </div>
          </a>
        ))}
      </div>
    </section>
  )}

  {/* INTERNAL LINKS */}
  {city && category && (
    <div class="mt-16">
      <h2 class="text-xl font-semibold text-[var(--color-deep-slate)] mb-4">Mehr {category.name} in {city.name}</h2>
      <a
        href={`/directory/city/${city.slug}/${category.slug}`}
        class="inline-block bg-[var(--color-warm-cream)] text-[var(--color-deep-slate)] border border-[var(--color-light-taupe)] px-6 py-3 rounded-xl transition-colors hover:border-[var(--color-gentle-gold)] hover:text-[var(--color-gentle-gold)]"
      >
        Alle {category.name} in {city.name} anzeigen
      </a>
    </div>
  )}

</section>

</DirectoryLayout>

<style>
  .salon-hero::after {
    content: "";
    position: absolute;
    inset: 0;
    background: linear-gradient(
      180deg,
      transparent 0%,
      color-mix(in srgb, var(--color-deep-slate) 88%, transparent) 100%
    );
    pointer-events: none;
  }

  .salon-hero-content {
    position: absolute;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    padding: 1.25rem 1rem;
  }

  .salon-hero-content h1 {
    color: var(--color-soft-white);
    margin: 0 0 0.75rem;
  }

  .salon-hero-content p {
    color: var(--color-light-taupe);
    margin: 0 0 1rem;
  }

  @media (min-width: 768px) {
    .salon-hero-content {
      flex-direction: row;
      align-items: flex-end;
      justify-content: space-between;
      gap: 1.5rem;
      padding: 1.75rem 1.5rem;
    }
  }

  .salon-hero-pill {
    background: color-mix(in srgb, var(--color-deep-slate) 60%, transparent);
    border: 1px solid rgba(230,226,221,0.25);
    color: var(--color-soft-white);
    backdrop-filter: blur(10px);
  }

  /* Rating stars should read as gold on the dark hero. */
  .salon-rating-pill {
    color: var(--color-gentle-gold);
    border-color: color-mix(in srgb, var(--color-gentle-gold) 40%, transparent);
  }

  a.salon-hero-pill:hover {
    border-color: rgba(230,226,221,0.45);
    background: color-mix(in srgb, var(--color-deep-slate) 70%, transparent);
  }

  /* Primary CTA matches "Book button": terracotta + white text, darker on hover. */
  .salon-cta {
    background: var(--color-terracotta);
    color: var(--color-soft-white);
  }

  .salon-cta:hover { filter: brightness(0.92); }

  .salon-cta-gold {
    color: color-mix(in srgb, var(--color-deep-slate) 92%, #2f2408);
    background:
      radial-gradient(circle at top right, color-mix(in srgb, var(--color-soft-white) 22%, transparent) 0%, transparent 50%),
      linear-gradient(120deg, color-mix(in srgb, var(--color-gentle-gold) 68%, #d4af37), color-mix(in srgb, var(--color-gentle-gold) 82%, #c89f2f));
    border: 1px solid color-mix(in srgb, var(--color-gentle-gold) 45%, #b98d20);
  }

  .salon-cta-gold:hover {
    filter: brightness(0.97);
  }

  .salon-cta-secondary:hover {
    border-color: rgba(230,226,221,0.8);
    background: color-mix(in srgb, var(--color-deep-slate) 40%, transparent);
  }

  .offer-banners {
    display: grid;
    grid-template-columns: 1fr;
    gap: 0.875rem;
  }

  @media (min-width: 768px) {
    .offer-banners {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
  }

  @media (min-width: 1024px) {
    .offer-banners {
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }
  }

  .offer-banner-card {
    display: block;
    border: 1px solid color-mix(in srgb, var(--color-gentle-gold) 40%, var(--color-light-taupe));
    border-radius: 1rem;
    padding: 1rem;
    background:
      radial-gradient(circle at top right, color-mix(in srgb, var(--color-soft-white) 22%, transparent) 0%, transparent 50%),
      linear-gradient(120deg, color-mix(in srgb, var(--color-gentle-gold) 68%, #d4af37), color-mix(in srgb, var(--color-gentle-gold) 82%, #c89f2f));
    text-decoration: none;
    transition: transform 160ms ease, filter 160ms ease, box-shadow 160ms ease;
  }

  .offer-banner-card:hover {
    transform: translateY(-2px);
    filter: brightness(0.97);
    box-shadow: var(--shadow-sm);
  }

  .offer-banner-card:focus-visible {
    outline: 2px solid color-mix(in srgb, var(--color-deep-slate) 65%, transparent);
    outline-offset: 2px;
  }

  .offer-banner-eyebrow {
    margin: 0 0 0.4rem;
    font-size: 0.72rem;
    letter-spacing: 0.16em;
    text-transform: uppercase;
    color: color-mix(in srgb, var(--color-deep-slate) 75%, #5b4a1a);
    font-weight: 700;
  }

  .offer-banner-card h2 {
    margin: 0;
    font-size: 1rem;
    line-height: 1.4;
    color: color-mix(in srgb, var(--color-deep-slate) 90%, #2f2408);
    font-weight: 700;
  }
</style>



