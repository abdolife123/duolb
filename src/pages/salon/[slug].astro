---
export const prerender = false;

import DirectoryLayout from "../../layouts/DirectoryLayout.astro"
import SalonImage from "../../components/directory/SalonImage.astro"
import { supabase } from "../../lib/supabase"

const { slug } = Astro.params

const fallbackCover =
  "https://res.cloudinary.com/daxbch3om/image/upload/v1770339624/7b93947b-000b-4572-beb1-fbcd14924b7b_1_lo30fm.png"

const { data: salon } = await supabase
  .from("salons")
  .select("*")
  .eq("slug", slug)
  .maybeSingle()

if (!salon) {
  return Astro.redirect("/directory")
}

const coverImage =
  typeof salon.cover_image === "string" && salon.cover_image.trim()
    ? salon.cover_image
    : fallbackCover

const phoneLink =
  typeof salon.phone === "string"
    ? salon.phone.replace(/[^\d+]/g, "")
    : ""

let city = null
if (salon.city_id) {
  const { data } = await supabase
    .from("cities")
    .select("name, slug")
    .eq("id", salon.city_id)
    .maybeSingle()
  city = data
}

let category = null
if (salon.category_id) {
  const { data } = await supabase
    .from("categories")
    .select("name, slug")
    .eq("id", salon.category_id)
    .maybeSingle()
  category = data
}

const relatedConditions = []
if (salon.city_id) relatedConditions.push(`city_id.eq.${salon.city_id}`)
if (salon.category_id) relatedConditions.push(`category_id.eq.${salon.category_id}`)

let relatedSalons = []
if (relatedConditions.length > 0) {
  const { data: relatedRaw, error: relatedError } = await supabase
    .from("salons")
    .select(
      "salon_name, slug, cover_image, rating_value, rating_count, full_address, city_id, category_id"
    )
    .neq("slug", salon.slug)
    .or(relatedConditions.join(","))
    .limit(24)

  if (relatedError) {
    console.error("related salons error", relatedError)
  }

  relatedSalons = (relatedRaw || [])
    .map((item) => {
      const isSameCity = Boolean(salon.city_id && item.city_id === salon.city_id)
      const isSameCategory = Boolean(
        salon.category_id && item.category_id === salon.category_id
      )
      const score = (isSameCity ? 2 : 0) + (isSameCategory ? 2 : 0)

      return { ...item, score }
    })
    .sort((a, b) => {
      if (b.score !== a.score) return b.score - a.score
      return (b.rating_value ?? 0) - (a.rating_value ?? 0)
    })
    .slice(0, 6)
}

// SEO
const title = `${salon.salon_name}${city ? ` in ${city.name}` : ""} – ${category?.name || "Salon"}`
const description =
  salon.description?.slice(0, 155) ||
  `${salon.salon_name} in ${city?.name}. Adresse, Bewertungen und Leistungen im Überblick.`

Astro.response.headers.set(
  "Cache-Control",
  "public, max-age=0, s-maxage=600, stale-while-revalidate=86400"
)

const salonSchema = {
  "@context": "https://schema.org",
  "@type": "BeautySalon",
  name: salon.salon_name,
  url: `https://duolb.com/salon/${salon.slug}`,
  image: coverImage,
  description,
  telephone: salon.phone || undefined,
  address:
    salon.full_address || salon.postal_code || city?.name
      ? {
          "@type": "PostalAddress",
          streetAddress: salon.full_address || undefined,
          postalCode: salon.postal_code || undefined,
          addressLocality: city?.name || undefined,
          addressCountry: "DE",
        }
      : undefined,
  geo:
    salon.latitude && salon.longitude
      ? {
          "@type": "GeoCoordinates",
          latitude: salon.latitude,
          longitude: salon.longitude,
        }
      : undefined,
  aggregateRating:
    salon.rating_value
      ? {
          "@type": "AggregateRating",
          ratingValue: salon.rating_value,
          ratingCount: salon.rating_count ?? 0,
        }
      : undefined,
}
---

<head>
  <script
    type="application/ld+json"
    set:html={JSON.stringify(salonSchema, (key, value) =>
      value === undefined ? undefined : value
    )}
  />
</head>

<DirectoryLayout
  title={title}
  description={description}
  canonical={`https://duolb.com/salon/${salon.slug}`}
  image={coverImage}
>

<section class="max-w-6xl mx-auto px-6 py-14 text-slate-800">

  {/* HERO IMAGE */}
  <div class="rounded-3xl overflow-hidden shadow-xl ring-1 ring-slate-200 mb-10">
    <img
      src={coverImage}
      alt={`${salon.salon_name}${city ? ` in ${city.name}` : ""}`}
      class="w-full h-80 object-cover"
      loading="eager"
      decoding="async"
      fetchpriority="high"
      onerror={`this.onerror=null;this.src='${fallbackCover}';`}
    />
  </div>

  {/* HEADER */}
  <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-6 mb-10">
    <div>
      <h1 class="text-4xl md:text-5xl font-bold tracking-tight text-slate-900 mb-3 leading-tight">
        {salon.salon_name}{city ? ` in ${city.name}` : ""}
      </h1>

      <p class="text-base md:text-lg text-slate-600 max-w-3xl mb-4">
        Entdecke Leistungen, Standort und Kontaktdaten auf einen Blick.
      </p>

      <div class="flex flex-wrap items-center gap-3 text-sm">
        {category && (
          <a href={`/directory/city/${city?.slug}/${category.slug}`} class="bg-amber-50 text-amber-900 border border-amber-200 px-3 py-1 rounded-full hover:bg-amber-100 transition">
            {category.name}
          </a>
        )}
        {salon.rating_value && (
          <span class="text-amber-700 font-semibold bg-amber-50 border border-amber-200 px-3 py-1 rounded-full">
            ⭐ {salon.rating_value} ({salon.rating_count ?? 0})
          </span>
        )}
        {salon.has_offers && (
          <span class="bg-emerald-50 text-emerald-700 border border-emerald-200 px-3 py-1 rounded-full">
            Angebote verfügbar
          </span>
        )}
      </div>
    </div>

    <div class="flex flex-wrap gap-3 md:justify-end">
      {phoneLink && (
        <a href={`tel:${phoneLink}`} class="bg-slate-900 text-white px-6 py-3 rounded-xl font-semibold shadow-sm hover:bg-slate-800 transition">
          Anrufen
        </a>
      )}
      {salon.website && (
        <a href={salon.website} target="_blank" rel="noopener" class="border border-slate-300 text-slate-700 bg-white px-6 py-3 rounded-xl font-semibold hover:bg-slate-50 transition">
          Website
        </a>
      )}
    </div>
  </div>

  {/* ADDRESS */}
  <div class="bg-white rounded-2xl shadow-sm p-6 mb-10 border border-slate-200">
    <h2 class="text-xl font-semibold text-slate-900 mb-3">Adresse</h2>
    <p class="text-slate-700 leading-relaxed">
      {salon.full_address}, {salon.postal_code} {city?.name}
    </p>
  </div>

  {/* DESCRIPTION */}
  {salon.description && (
    <div class="prose prose-slate max-w-none mb-12">
      <h2 class="!text-slate-900">Über {salon.salon_name}</h2>
      <p class="whitespace-pre-line !leading-relaxed">{salon.description}</p>
    </div>
  )}

  {/* SERVICES SEO BLOCK */}
  {category && city && (
    <div class="prose prose-slate max-w-none mb-12">
      <h2 class="!text-slate-900">{category.name} in {city.name}</h2>
      <p>
        {salon.salon_name} gehört zu den etablierten Anbietern für {category.name} in {city.name}.
        Besucher schätzen vor allem die Qualität der Leistungen, das freundliche Team
        und die angenehme Atmosphäre vor Ort.
      </p>
    </div>
  )}

  {/* MAP */}
  {salon.latitude && salon.longitude && (
    <div class="mb-12">
      <h2 class="text-2xl font-semibold text-slate-900 mb-4">Standort auf der Karte</h2>
      <iframe
        width="100%"
        height="350"
        loading="lazy"
        class="rounded-2xl border border-slate-200"
        src={`https://www.google.com/maps?q=${salon.latitude},${salon.longitude}&output=embed`}
      ></iframe>
    </div>
  )}

  {/* RELATED SALONS */}
  {relatedSalons.length > 0 && (
    <section class="mt-16 mb-10">
      <div class="flex flex-wrap items-end justify-between gap-4 mb-6">
        <h2 class="text-2xl font-semibold text-slate-900">
          Ähnliche Salons
        </h2>
        {city && (
          <a
            href={`/directory/city/${city.slug}`}
            class="text-sm font-semibold text-amber-700 hover:text-amber-800"
          >
            Mehr in {city.name}
          </a>
        )}
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {relatedSalons.map((item) => (
          <a
            href={`/salon/${item.slug}`}
            class="bg-white rounded-2xl overflow-hidden shadow-sm border border-slate-200 hover:shadow-md transition"
          >
            <SalonImage
              coverImage={item.cover_image}
              alt={`${item.salon_name}${city ? ` in ${city.name}` : ""}`}
              class="h-44 w-full object-cover"
            />
            <div class="p-4">
              <h3 class="font-semibold text-slate-900 mb-2">{item.salon_name}</h3>
              <p class="text-sm text-slate-500 line-clamp-2 mb-2">
                {item.full_address || "Adresse nicht verfügbar"}
              </p>
              <div class="text-sm text-amber-700">
                ⭐ {item.rating_value ?? "–"} ({item.rating_count ?? 0})
              </div>
            </div>
          </a>
        ))}
      </div>
    </section>
  )}

  {/* INTERNAL LINKS */}
  {city && category && (
    <div class="mt-16">
      <h2 class="text-xl font-semibold text-slate-900 mb-4">Mehr {category.name} in {city.name}</h2>
      <a
        href={`/directory/city/${city.slug}/${category.slug}`}
        class="inline-block bg-amber-50 text-amber-900 border border-amber-200 px-6 py-3 rounded-xl hover:bg-amber-100 transition"
      >
        Alle {category.name} in {city.name} anzeigen
      </a>
    </div>
  )}

</section>

</DirectoryLayout>



