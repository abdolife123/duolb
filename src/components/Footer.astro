---
// Footer.astro
import { supabase } from "../lib/supabase";

const currentYear = new Date().getFullYear();

const { data: linkRows } = await supabase
  .from("city_category_pages")
  .select("salon_count, cities!inner(name, slug), business_categories!inner(name, slug)")
  .gt("salon_count", 0);

const cityMap = new Map();
const categoryMap = new Map();

for (const row of linkRows || []) {
  const city = Array.isArray(row.cities) ? row.cities[0] : row.cities;
  const category = Array.isArray(row.business_categories)
    ? row.business_categories[0]
    : row.business_categories;
  const count = row.salon_count ?? 0;

  if (city?.slug && city?.name) {
    const current = cityMap.get(city.slug) || { name: city.name, slug: city.slug, count: 0 };
    current.count += count;
    cityMap.set(city.slug, current);
  }

  if (category?.slug && category?.name) {
    const current = categoryMap.get(category.slug) || { name: category.name, slug: category.slug, count: 0 };
    current.count += count;
    categoryMap.set(category.slug, current);
  }
}

const topCities = [...cityMap.values()]
  .sort((a, b) => b.count - a.count)
  .slice(0, 10);

const topCategories = [...categoryMap.values()]
  .sort((a, b) => b.count - a.count)
  .slice(0, 10);
---

<footer class="border-t pt-20 pb-10 footer-root">
  <div class="max-w-7xl mx-auto px-6">
    <div class="flex flex-col items-center">
      <div class="mb-8">
        <a
          href="/"
          class="text-3xl font-serif tracking-[0.04em] group footer-logo"
        >
          duolb<span class="footer-dot group-hover:animate-pulse">.</span>
        </a>
      </div>

      <nav class="flex flex-wrap justify-center gap-x-8 gap-y-4 mb-12">
        {
          [
            { name: "Über uns", href: "/about" },
            { name: "Kontakt", href: "/contact" },
            { name: "Impressum", href: "/impressum" },
            { name: "Datenschutz", href: "/datenschutz" },
          ].map((link) => (
            <a
              href={link.href}
              class="nav-link text-xs font-medium uppercase tracking-[0.2em] transition-colors footer-link"
            >
              {link.name}
            </a>
          ))
        }
      </nav>

      {(topCities.length > 0 || topCategories.length > 0) && (
        <div class="w-full max-w-5xl mb-12 grid grid-cols-1 md:grid-cols-2 gap-8">
          {topCities.length > 0 && (
            <section>
              <h3 class="text-xs font-semibold uppercase tracking-[0.2em] mb-4 footer-meta">Top Staedte</h3>
              <div class="flex flex-wrap gap-2">
                {topCities.map((city) => (
                  <a
                    href={`/directory/city/${city.slug}`}
                    class="text-xs px-3 py-1 rounded-full border border-[rgba(47,36,8,0.18)] footer-link"
                  >
                    {city.name}
                  </a>
                ))}
              </div>
            </section>
          )}

          {topCategories.length > 0 && (
            <section>
              <h3 class="text-xs font-semibold uppercase tracking-[0.2em] mb-4 footer-meta">Top Kategorien</h3>
              <div class="flex flex-wrap gap-2">
                {topCategories.map((category) => (
                  <a
                    href={`/directory/category/${category.slug}`}
                    class="text-xs px-3 py-1 rounded-full border border-[rgba(47,36,8,0.18)] footer-link"
                  >
                    {category.name}
                  </a>
                ))}
              </div>
            </section>
          )}
        </div>
      )}

      <div
        class="mb-8 h-px w-full max-w-xs footer-divider"
      >
      </div>

      <div class="flex flex-wrap justify-center gap-6 mb-8">
        <a
          href="https://www.instagram.com/duolb_com/"
          target="_blank"
          rel="noopener noreferrer"
          class="transition-transform hover:-translate-y-1 footer-social"
        >
          Instagram
        </a>
        <a
          href="https://web.facebook.com/profile.php?id=61587828371941"
          target="_blank"
          rel="noopener noreferrer"
          class="transition-transform hover:-translate-y-1 footer-social"
        >
          Facebook
        </a>
        <a
          href="https://de.pinterest.com/beautyguide_germany"
          target="_blank"
          rel="noopener noreferrer"
          class="transition-transform hover:-translate-y-1 footer-social"
        >
          Pinterest
        </a>
      </div>

      <div class="text-center">
        <p
          class="text-[10px] uppercase tracking-widest leading-loose footer-meta"
        >
          © {currentYear} duolb Schönheitsblog <br class="md:hidden" />
          <span class="hidden md:inline mx-2">•</span>
          Deutschland
        </p>
      </div>
    </div>
  </div>
</footer>

<style>
  .footer-root {
    background: linear-gradient(
      180deg,
      color-mix(in srgb, var(--color-gentle-gold) 82%, #f1d176),
      color-mix(in srgb, var(--color-gentle-gold) 92%, #c89f2f)
    );
    color: color-mix(in srgb, var(--color-deep-slate) 92%, #2f2408);
    border-top-color: color-mix(in srgb, var(--color-gentle-gold) 55%, #b98d20);
    font-family: var(--font-body);
  }

  .footer-logo {
    color: color-mix(in srgb, var(--color-deep-slate) 94%, #2f2408);
  }

  .footer-dot { color: var(--color-gentle-gold); }

  /* Keep serif utility consistent with design system tokens. */
  .font-serif { font-family: var(--font-accent); }

  .footer-divider {
    background: linear-gradient(
      90deg,
      transparent,
      rgba(230,226,221,0.2),
      transparent
    );
  }

  .footer-link,
  .footer-social {
    color: color-mix(in srgb, var(--color-deep-slate) 92%, #2f2408);
    transition: color var(--transition-base), transform var(--transition-base);
  }

  .footer-link:hover,
  .footer-social:hover {
    color: color-mix(in srgb, var(--color-deep-slate) 75%, #5b4a1a);
  }

  .footer-meta {
    color: color-mix(in srgb, var(--color-deep-slate) 85%, #4b3b11);
  }
</style>
